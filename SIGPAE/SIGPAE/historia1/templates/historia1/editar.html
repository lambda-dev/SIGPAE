{% extends 'historia1/base.html' %}
{% load static %}

{% block content %}
<div class="container">
  <div class="row">

    <h1 style="text-align:center;">Transcripción</h1>
  {% if request.GET.msg %}
    {% if request.GET.msg == "saved"%}
      <div style="text-align:center;" class="alert alert-success">La Transcripción ha sido guardada exitosamente</div>
    {% endif %}
  {% endif %}

    <div class="addFields">
      <button id="agregar" class="btn btn-primary col-md-12" type="button">Agregar Campo</button>

      <div id="tipoCampo" hidden>
        <select id="select">

          <option selected disabled hidden value="">Seleccione Un Tipo de Campo a Agregar</option>

          <optgroup label="Campos Normados">
            <option value="1">Requisitos</option>
            <option value="2">Objetivos</option>
            <option value="3">Estrategias Metodológicas</option>
            <option value="4">Estrategias de Evaluación</option>
          </optgroup>

          <optgroup label="Campos Adicionales">
            <option value="5">Justificación</option>
            <option value="6">Ninguna de las Anteriores</option>
          </optgroup>

        </select>
        <button id="nuevoCampo" class="btn btn-primary">Agregar</button>
      </div>
    </div>

    <div class="col-md-5 col-sm-5">
      <object data='{{url}}'
          type='application/pdf'
          width='100%'
          height='700px'/></object>
    </div>

    <div class="col-md-4 col-sm-4">
      <textareal id="id_pdf_to_text" name="pdf_to_text" width='100%'>
        <p style="text-align: center;">
          {{strng}}
        </p>
      </textareal>
    </div>

    <div class="col-md-3 col-sm-3">
    <form id="formS" method="post" enctype="multipart/form-data">
      {% if form_s.non_field_errors %}
        {% for error in form_s.non_field_errors %}
         <div class="alert alert-danger" role="alert"> {{error}}</div>
        {% endfor %}
      {% endif %}

      {% csrf_token %}
      {% for field in form_s %}

        {% if field.name in requeridos %}

          {% if field.name not in act %}

            <div class="form-group" id="{{field.auto_id}}" hidden>
            {{ field.label_tag }} {{ field }}
            </div>
            {% if field.errors %}
              {% for error in field.errors %}
                <div class="alert alert-danger" role="alert" hidden>{{ error }}</div>
              {% endfor %}
            {% endif %}

          {% else %}

            <div class="form-group" id="{{field.auto_id}}">
              {{ field.label_tag }} {{ field }}
              </div>
              {% if field.errors %}
                {% for error in field.errors %}
                  <div class="alert alert-danger" role="alert">{{ error }}</div>
                {% endfor %}
              {% endif %}

          {% endif %}

        {% else %}

            <div class="form-group" id="{{field.auto_id}}">
              {{ field.label_tag }} {{ field }}
              </div>
              {% if field.errors %}
                {% for error in field.errors %}
                  <div class="alert alert-danger" role="alert">{{ error }}</div>
                {% endfor %}
              {% endif %}

        {% endif %}

      {% endfor %}

      {{ form_.management_form }}
      {% for field in form_%}
        <div class="formset">
          {{ field.errors }}
          {{ field.label_tag }} {{ field }}
        </div>
      {% endfor %}

      <div style="display:none;" id="msg" class="alert alert-warning">Recuerde que para ser P.A.S.A. todos los campos <strong>obligatorios</strong> deben estar <strong>llenos</strong> y cumplir sus <strong>restricciones</strong></div>
      <button id="submit-btn" class="btn btn-primary btn-lg" type="submit">Guardar</button>

    <script>
    $(document).change(function(){
      var suma = 0;
      suma= Number($('#id_horas_teoria').find('input').val())+Number($('#id_horas_lab').find('input').val())+Number($('#id_horas_practica').find('input').val());
      if ((suma)>40){
          alert("La suma de las horas de teoría, laboratorio y práctica deben ser menor a 40.");
      }
      if (Number($('#id_creditos').find('input').val())>16){
          alert("Las Unidades Créditos debe ser un número entre 0 y 16.");
      }
      if (Number($('#id_year').find('input').val())<1969 && Number($('#id_year').find('input').val()) != 0){
          alert("El año de entrada en vigencia no puede ser menor a 1969.");
      }
      if (Number($('#id_year').find('input').val())>2017){
          alert("El año de entrada en vigencia no puede mayor al año actual.");
      }
    });
</script>
    </form>
    </div>
  </div>
</div>

<script>

  $('.formset').formset({
        addText: 'add link',
        deleteText: 'remove'
    });

  $('#agregar').on('click',function(){
    $("#tipoCampo").show();
  });

  var delete_click = $('.delete-row').last();
  delete_click.click();
  $('.add-row').hide();
  $('.delete-row').hide();

  $('#nuevoCampo').on('click',function(){
    x = $('select').val();
    console.log(x);
    switch (x) {
      case '1':
        $('.form-group:contains(Requisitos:)').show();
        break;
      case '2':
        $('.form-group:contains(Objetivos:)').show();
        break;
      case '3':
        $('.form-group:contains(Estrategias Metodológicas:)').show();
        break;
      case '4':
        $('.form-group:contains(Estrategias de Evaluación:)').show();
        break;
      case '5':
        $('.form-group:contains(Justificación:)').show()
        break;
      default:
        $('.add-row').click();
        break;
    }
  $('#select').prop('selectedIndex',0);
  $("#tipoCampo").hide();
  $('.delete-row').hide();

  //AGREGAR ESTA PARTE DEL SCRIPT

  $('#formS').submit(function(evt){
    x = validateForm();
    return x;
  });

  function validateForm(event){
    var i = 0;
    var z = true;
    $('div.formset').each(function(){
      var act = null;

      x = $(this).find('input').first();
      y = $(this).find('textarea').first();
      id = "id_form-"+String(i)+"-value";

      for (j=0; j < tinyMCE.editors.length; j++){
        if (tinyMCE.editors[j].id == id){
          act = tinyMCE.editors[j];
          break;
        }
      }

      if (act != null){
        content = act.getContent();
      }

      if (x.val() == '' || y.val() == '' || x.val() == null || y.val() == null || content == ""){
        console.log('SI');
        z = false;
        x.parent().find('#error').show();
      }else{
        x.parent().find('#error').hide();
      }
      i ++;
    });
    return z;
  }

  $('div.formset').each(function(){
    x = $(this).find('input').first();
    x.parent().prepend("<p id='error' style='color:red;display:none;'>Por favor llene ambos campos</p>");
  });

  $('.formset label').css('visibility','hidden');

  });

  // AGREGAR HASTA AQUI
</script>
{% endblock %}
